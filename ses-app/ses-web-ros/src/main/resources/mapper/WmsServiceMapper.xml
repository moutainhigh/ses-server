<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.redescooter.ses.web.ros.dao.WmsServiceMapper">
  <sql id="where_wmsProductList">
    WHERE
    s.dr=0
    <if test="enter.type!=''and enter.type!=null">
    and s.materiel_product_type=#{enter.type}
    </if>
    <if test="enter.keyword!=''and enter.keyword!=null">
    and (
    b.cn_name like concat ("%",#{enter.keyword},"%") or
    b.en_name like concat ("%",#{enter.keyword},"%") or
    b.product_number like concat ("%",#{enter.keyword},"%")
    )
    </if>
  </sql>
  <sql id="where_wmsPartsList">
    WHERE
      s.dr=0
    <if test="enter.type!=''and enter.type!=null">
      and s.materiel_product_type=#{enter.type}
    </if>
    <if test="enter.keyword!=''and enter.keyword!=null">
      and (
      p.cn_name like concat ("%",#{enter.keyword},"%") or
      p.en_name like concat ("%",#{enter.keyword},"%") or
      p.parts_number like concat ("%",#{enter.keyword},"%")
      )
    </if>
  </sql>
  <select
    id="WmsUsableStockCount" resultType="int">
    SELECT
     count(*) from (
    select
    b.cn_name as cnName,
    b.en_name as enName,
    b.product_number as productNumber,
    s.int_total as intTotal,
    e.sales_price as price
    FROM
    ope_stock s
    JOIN ope_parts_product b ON s.materiel_product_id = b.id and b.dr = 0
    JOIN ope_regional_price_sheet e ON b.id = e.parts_product_id and e.dr = 0
    <include refid="where_wmsProductList"></include>
    UNION
    SELECT
    p.cn_name as cnName,
    p.en_name as enName,
    p.parts_number as productNumber,
    s.int_total as intTotal,
    e.price as price
    FROM
    ope_stock s
    JOIN ope_parts p ON s.materiel_product_id = p.id and p.dr = 0
    JOIN ope_price_sheet e ON s.id = e.parts_id and e.dr = 0
    <include refid="where_wmsPartsList"></include>
    ) aa
  </select>


  <select id="WmsUsableStockList" resultType="com.redescooter.ses.web.ros.vo.wms.WmsStockAvailableResult">
    SELECT
     * from ((SELECT
    b.cn_name as cnName,
    b.en_name as enName,
    b.product_number as productNumber,
    s.int_total as intTotal,
    e.sales_price as price
  FROM
    ope_stock s
    JOIN ope_parts_product b ON s.materiel_product_id = b.id and b.dr = 0
    JOIN ope_regional_price_sheet e ON b.id = e.parts_product_id and e.dr = 0
        <include refid="where_wmsProductList"></include>
        order by s.updated_time desc)
    UNION
  (SELECT
    p.cn_name as cnName,
    p.en_name as enName,
    p.parts_number as productNumber,
    s.int_total as intTotal,
    e.price as price
  FROM
    ope_stock s
    JOIN ope_parts p ON s.materiel_product_id = p.id and p.dr = 0
    JOIN ope_price_sheet e ON s.id = e.parts_id and e.dr = 0
    <include refid="where_wmsPartsList"></include>
    order by s.updated_time desc))
    bb limit #{enter.startRow},#{enter.pageSize}
  </select>

</mapper>
