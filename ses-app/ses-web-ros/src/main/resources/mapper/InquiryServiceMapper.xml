<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.redescooter.ses.web.ros.dao.InquiryServiceMapper">

    <sql id="where_inquiryList">
        where inquiry.dr=0
        <if test="status != null and status != ''">
            and inquiry.status= #{status}
        </if>
        <if test="status == null or status == ''">
            and inquiry.status in ('1','3','4','5')
        </if>
        <if test="cityId != null">
            and inquiry.city =#{cityId}
        </if>
        <if test="distrustId != null">
            and inquiry.district = #{distrustId}
        </if>
        <if test="industyType != null and industyType != ''">
            and inquiry.industry = #{industyType}
        </if>
        <if test="customerType != null and customerType != ''">
            and inquiry.customer_type = #{customerType}
        </if>
        <if test="acceptanceStartTime != null and acceptanceEndTime != null">
            and inquiry.status = 3
            and (inquiry.updated_time between #{acceptanceStartTime} and #{acceptanceEndTime})
        </if>
        <if test="keyword != null and keyword != ''">
            and (
            inquiry.first_name like concat("%",#{keyword},"%")
            or inquiry.last_name like concat("%",#{keyword},"%")
            or inquiry.full_name like concat("%",#{keyword},"%")
            or inquiry.contant_full_name like concat("%",#{keyword},"%")
            or inquiry.first_name like concat("%",#{keyword},"%")
            or inquiry.last_name like concat("%",#{keyword},"%")
            )
        </if>
    </sql>

    <sql id="InquiryResult">
            inquiry.id                                         as id,
           inquiry.first_name                                 as customerFirstName,
           inquiry.last_name                                  as customerLastName,
           inquiry.full_name                                  as customerFullName,
           inquiry.contact_first                              as contactFirstName,
           inquiry.contact_last                               as contactLastName,
           inquiry.contant_full_name                          as contactFullName,
           inquiry.email                                      as email,
           inquiry.telephone                                  as telephone,
           inquiry.city                                       as cityId,
           inquiry.district                                   as distrustId,
           inquiry.status                                     as status,
           inquiry.customer_type                              as customerType,
           inquiry.industry                                   as industryType,
           inquiry.scooter_quantity                           as scooterQty,
           inquiry.remarks                                    as remark,
           if(inquiry.status = 3, inquiry.updated_time, null) as acceptanceTime,
           inquiry.company_name                                as companyName,
           inquiry.country_code                               as countryCode,
           inquiry.source                                     as source,
            inquiry.address                                    as address
    </sql>

    <select id="countStatus" resultType="com.redescooter.ses.api.common.vo.CountByStatusResult">
        select inquiry.status as status, count(*) as totalCount
        from ope_customer_inquiry inquiry
        group by inquiry.status
    </select>


    <select id="inquiryListCount" resultType="int">
        select count(*)
        from ope_customer_inquiry inquiry
        <include refid="where_inquiryList"/>
    </select>
    <select id="inquiryList" resultType="com.redescooter.ses.web.ros.vo.inquiry.InquiryResult">
        select
        <include refid="InquiryResult"/>
        from ope_customer_inquiry inquiry
        <include refid="where_inquiryList"/>
        order by inquiry.created_time desc
        limit #{startRow},#{pageSize}
    </select>

    <select id="inquiryDetail" resultType="com.redescooter.ses.web.ros.vo.inquiry.InquiryResult">
        select
        <include refid="InquiryResult"/>
        from ope_customer_inquiry inquiry
        where inquiry.dr=0
        and inquiry.id=#{id}
    </select>

    <select id="usingEmailList" resultType="java.lang.String">
        select email
        from ope_customer_inquiry
        where dr = 0
        where status != 3
        union
        select email
        from ope_customer
        where dr = 0
          and ope_customer.status in (1, 2)
    </select>

    <select id="exportInquiry" resultType="com.redescooter.ses.web.ros.vo.inquiry.InquiryResult">
     select
        <include refid="InquiryResult"/>
        from ope_customer_inquiry inquiry
        where source = 1 and dr = 0
        order by inquiry.created_time desc
    </select>
</mapper>
