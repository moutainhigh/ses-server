<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.redescooter.ses.mobile.rps.dao.entrustorder.EntrustOrderMapper">

    <!--委托单列表查询条件sql-->
    <sql id="queryEntrustOrderListWhere">
        <if test="type != null">and entrust_type = #{type}</if>
        <if test="status == 0">and entrust_status = 0</if>
        <if test="status == 1">and entrust_status in(10, 20)</if>
    </sql>

    <!--委托单类型数量统计-->
    <select id="getEntrustOrderTypeCount" resultType="com.redescooter.ses.api.common.vo.CountByStatusResult">
        select entrust_type `status`, count(id) totalCount
	    from ope_entrust_order
	    where dr = 0 and entrust_status = 0
	    group by entrust_type
    </select>

    <!--委托单列表查询-->
    <select id="getEntrustOrderList" parameterType="com.redescooter.ses.mobile.rps.vo.entrustorder.QueryEntrustOrderParamDTO"
            resultType="com.redescooter.ses.mobile.rps.vo.entrustorder.QueryEntrustOrderResultDTO">
        select id, entrust_no entrustNo, consignor_qty qty, entrust_status `status`,entrust_type `type`
        from ope_entrust_order
        where dr = 0
        <include refid="queryEntrustOrderListWhere" />
        order by created_time asc
        limit #{startRow}, #{pageSize}
    </select>

    <!--查询委托单数量-->
    <select id="countByEntrustOrder" parameterType="com.redescooter.ses.mobile.rps.vo.entrustorder.QueryEntrustOrderParamDTO"
            resultType="java.lang.Integer">
        select count(*)
        from ope_entrust_order
        where dr = 0
        <include refid="queryEntrustOrderListWhere" />
    </select>

    <!--根据id查询委托单详情-->
    <select id="getEntrustOrderDetailById" parameterType="java.lang.Long" resultType="com.redescooter.ses.mobile.rps.vo.entrustorder.EntrustOrderDetailDTO">
        select id, entrust_no entrustNo, entrust_status entrustStatus, entrust_type entrustType,
        delivery_date deliveryDate, trans_type transType, consignor_qty qty, already_consignor_qty alreadyConsignorQty
        from ope_entrust_order
        where dr = 0 and id = #{id}
    </select>

    <!--修改委托单已发货数量-->
    <update id="updateEntrustOrderAlreadyConsignorQty" parameterType="com.redescooter.ses.mobile.rps.dm.OpeEntrustOrder">
        update ope_entrust_order
	    set already_consignor_qty = already_consignor_qty + 1, updated_time = #{updatedTime}
	    where id = #{id}
    </update>

</mapper>