<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.redescooter.ses.web.delivery.dao.TaskServiceMapper">
    <select id="countByStatus" resultType="com.redescooter.ses.api.common.vo.CountByStatusResult">
        select count(*) totalCount, status
        from cor_express_delivery express
        where express.dr = 0
        and express.tenant_id =#{tenantId}
        group by express.status
    </select>
    <select id="taskCount" resultType="int">
        select count(*)
        from cor_express_delivery express
        inner join cor_driver driver on express.driver_id = driver.id and driver.dr = 0 and driver.status = 1
        inner join cor_driver_scooter dscooter
        on dscooter.driver_id = driver.id and dscooter.status = 1 and dscooter.dr = 0
        inner join cor_user_profile profile on driver.user_id = profile.user_id and profile.dr = 0
        inner join cor_tenant_scooter tscooter on tscooter.scooter_id = dscooter.scooter_id and tscooter.dr=0
        where express.tenant_id =#{tenantId}
        and express.dr = 0
        <if test="status != null and status != ''">
            and express.status=#{status}
        </if>
        <if test="taskStartTime != null and taskStartTime != '' and taskEndTime != null and taskEndTime != ''">
            and express.delivery_date between #{taskStartTime} and #{taskEndTime}
        </if>
        <if test="startStartTime != null and startStartTime != '' and startEndTime != null and startEndTime != ''">
            and (express.delivery_start_time between #{startStartTime} and #{startEndTime})
        </if>
        <if
                test="deliveredStartTime != null and deliveredStartTime != '' and  deliveredEndTime != null and deliveredEndTime != ''">
            and (express.delivery_end_time between #{deliveredStartTime} and #{deliveredEndTime})
        </if>
        <if test="keyword != null and keyword != ''">
            and (profile.first_name like concat('%',#{keyword},'%') or
            profile.last_name like concat('%',#{keyword},'%') or
            profile.full_name like concat('%',#{keyword},'%') or
            tscooter.license_plate like concat('%',#{keyword},'%')
            )
        </if>
    </select>
    <select id="taskList" resultType="com.redescooter.ses.web.delivery.vo.task.TaskResult">

        select express.id as id,
        express.status as status,
        driver.id as driverId,
        profile.first_name as driverFirstName,
        profile.last_name as driverLastName,
        tscooter.scooter_id as scooterId,
        tscooter.license_plate as licensePlate,
        express.order_complete_num as completeCount,
        express.order_sum as totalCount,
        express.delivery_date as taskTime,
        express.delivery_start_time as startTime,
        express.delivery_end_time as deliveredTime
        from cor_express_delivery express
        inner join cor_driver driver on express.driver_id = driver.id and driver.dr = 0 and driver.status = 1
        inner join cor_driver_scooter dscooter
        on dscooter.driver_id = driver.id and dscooter.status = 1 and dscooter.dr = 0
        inner join cor_user_profile profile on driver.user_id = profile.user_id and profile.dr = 0
        inner join cor_tenant_scooter tscooter on tscooter.scooter_id = dscooter.scooter_id and tscooter.dr=0
        where express.tenant_id =#{tenantId}
        and express.dr = 0
        <if test="status != null and status != ''">
            and express.status=#{status}
        </if>
        <if test="taskStartTime != null and taskStartTime != '' and taskEndTime != null and taskEndTime != ''">
            and express.delivery_date between #{taskStartTime} and #{taskEndTime}
        </if>
        <if test="startStartTime != null and startStartTime != '' and startEndTime != null and startEndTime != ''">
            and (express.delivery_start_time between #{startStartTime} and #{startEndTime})
        </if>
        <if
                test="deliveredStartTime != null and deliveredStartTime != '' and  deliveredEndTime != null and deliveredEndTime != ''">
            and (express.delivery_end_time between #{deliveredStartTime} and #{deliveredEndTime})
        </if>
        <if test="keyword != null and keyword != ''">
            and (profile.first_name like concat('%',#{keyword},'%') or
            profile.last_name like concat('%',#{keyword},'%') or
            profile.full_name like concat('%',#{keyword},'%') or
            tscooter.license_plate like concat('%',#{keyword},'%')
            )
            order by express.create_time desc
            limit #{startRow},#{pageSize}
        </if>
    </select>
    <select id="detail" resultType="com.redescooter.ses.web.delivery.vo.task.TaskResult">
        select express.id as id,
        express.status as status,
        driver.id as driverId,
        profile.first_name as driverFirstName,
        profile.last_name as driverLastName,
        profile.tel_number_1 as driverPhone,
        profile.email_1 as driverEmail,
        tscooter.scooter_id as scooterId,
        tscooter.license_plate as licensePlate,
        express.order_complete_num as completeCount,
        express.order_sum as totalCount,
        express.delivery_date as taskTime,
        express.delivery_start_time as startTime,
        express.delivery_end_time as deliveredTime,
        express.create_time as createdTime
        from cor_express_delivery express
        inner join cor_driver driver on express.driver_id = driver.id and driver.dr = 0 and driver.status = 1
        inner join cor_driver_scooter dscooter
        on dscooter.driver_id = driver.id and dscooter.status = 1 and dscooter.dr = 0
        inner join cor_user_profile profile on driver.user_id = profile.user_id and profile.dr = 0
        inner join cor_tenant_scooter tscooter on tscooter.scooter_id = dscooter.scooter_id and tscooter.dr = 0
        where express.tenant_id =#{tenantId}
        and express.dr = 0
        and express.id =#{id}
    </select>
</mapper>