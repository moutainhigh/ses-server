<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.redescooter.ses.web.delivery.dao.DriverServiceMapper">

    <select id="listCount" resultType="int">
        select count(cdr.id)
        from cor_driver cdr
        inner join cor_user_profile cup on cdr.user_id = cup.user_id and cup.dr = 0
        inner join cor_driver_scooter cds on cdr.id = cds.driver_id and cds.dr = 0
        left join cor_tenant_scooter cts on cds.scooter_id = cts.scooter_id and cts.dr = 0
        <where>
            cdr.dr=0
            and cdr.tenant_id = #{tenantId}
            <if test="keyword != null and keyword != ''">
                and (
                cup.first_name like concat("%",#{keyword},"%")
                or cup.last_name like concat("%",#{keyword},"%")
                or cup.email_1 like concat("%",#{keyword},"%")
                or cup.tel_number_1 like concat("%",#{keyword},"%")
                )
            </if>
            <if test="status != null and status != ''">
                and cdr.status = #{status}
            </if>
        </where>

    </select>
    <select id="list" resultType="com.redescooter.ses.web.delivery.vo.ListDriverResult">
        select cdr.id,
        cdr.status,
        cup.picture as avatar,
        cup.place_birth as address,
        cup.first_name as driverFirstName,
        cup.last_name as driverLastName,
        cup.email_1 as email,
        cup.country_code_1 as countryCodel,
        cup.tel_number_1 as driverPhone,
        cts.license_plate as plateNumber,
        cdr.def1 as activatBoolean
        from cor_driver cdr
        inner join cor_user_profile cup on cdr.user_id = cup.user_id and cup.dr = 0
        inner join cor_driver_scooter cds on cdr.id = cds.driver_id and cds.dr = 0
        left join cor_tenant_scooter cts on cds.scooter_id = cts.scooter_id and cts.dr = 0
        <where>
            cdr.tenant_id=#{tenantId}
            and cdr.dr=0
            <if test="keyword != null and keyword != ''">
                and (
                cup.first_name like concat("%",#{keyword},"%")
                or cup.last_name like concat("%",#{keyword},"%")
                or cup.email_1 like concat("%",#{keyword},"%")
                or cup.tel_number_1 like concat("%",#{keyword},"%")
                )
            </if>
            <if test="status != null and status != ''">
                and cdr.status = #{status}
            </if>
        </where>
        <choose>
            <when test="map==false">
                order by cdr.status asc
            </when>
            <when test="map==true">
                order by cdr.status desc, cdr.def1 desc
            </when>
        </choose>
        limit #{startRow},#{pageSize}
    </select>
    <select id="countStatus" resultType="com.redescooter.ses.api.common.vo.CountByStatusResult">
        select cd.status, count(*) totalCount
        from cor_driver cd
        where cd.dr = 0
        and cd.tenant_id=#{tenantId}
        and cd.status != '3'
        group by cd.status
    </select>
    <select id="driverDeliveryCountByStatus"
            resultType="com.redescooter.ses.api.common.vo.CountByStatusResult">
       select trace.status, count(*) totalCount
        from cor_delivery_trace trace
                 inner join cor_driver cd on trace.user_id = cd.user_id
        where trace.dr = 0
          and trace.tenant_id = #{tenantId}
          and trace.status in ('3', '5', '6', '7')
          and cd.id = #{id}
        group by trace.status
    </select>
    <select id="deliveryHistroyCount" resultType="int">
       select count(*)
        from cor_delivery_trace trace
                 inner join cor_driver cd on trace.user_id = cd.user_id and cd.dr = 0
                 inner join cor_delivery delivery on trace.delivery_id = delivery.id and delivery.dr = 0
        where trace.tenant_id = #{tenantId}
          and trace.dr = 0
          and cd.id = #{id}
          and trace.status in (
                               '3', '5', '6', '7'
            )
    </select>
    <select id="deliveryHistroyList" resultType="com.redescooter.ses.web.delivery.vo.DeliveryHistroyResult">
    select trace.delivery_id  as id,
           delivery.order_no  as orderNo,
           trace.status       as status,
           delivery.recipient as recipient,
           trace.created_time as createdTime,
           delivery.ata       as completeTime
    from cor_delivery_trace trace
             inner join cor_driver cd on trace.user_id = cd.user_id and cd.dr = 0
             inner join cor_delivery delivery on trace.delivery_id = delivery.id and delivery.dr = 0
    where trace.tenant_id = #{tenantId}
      and trace.dr = 0
      and cd.id = #{id}
      and trace.status in (
                           '3', '5', '6', '7'
        )
        order by  delivery.created_time ASC
        limit #{startRow},#{pageSize}
    </select>

    <select id="driverscooterHistroyCount" resultType="int">
        select
        count(*)
        from cor_driver_scooter_history cdsh
        inner join cor_tenant_scooter cts on cdsh.scooter_id = cts.scooter_id and cts.dr = 0
        left join cor_scooter_ride_stat_detail csrsd on cdsh.scooter_id = csrsd.scooter_id and csrsd.dr = 0
        where cdsh.status = 2
        and cdsh.tenant_id = #{tenantId}
        and cdsh.driver_id = #{id}
        and (csrsd.create_time between cdsh.begin_time and cdsh.end_time)
    </select>

    <select id="driverscooterHistroyList"
            resultType="com.redescooter.ses.web.delivery.vo.DriverScooterHistoryResult">
        select cdsh.driver_id     as id,
        cts.license_plate  as licensePlate,
        cdsh.begin_time    as beginTime,
        cdsh.end_time      as endTime,
        sum(csrsd.mileage) as mileage
        from cor_driver_scooter_history cdsh
        inner join cor_tenant_scooter cts on cdsh.scooter_id = cts.scooter_id and cts.dr = 0
        left join cor_scooter_ride_stat_detail csrsd on cdsh.scooter_id = csrsd.scooter_id and csrsd.dr = 0
        where cdsh.status = 2
        and cdsh.tenant_id = #{tenantId}
        and cdsh.driver_id = #{id}
        and (csrsd.create_time between cdsh.begin_time and cdsh.end_time)
        group by id, licensePlate, beginTime, endTime
        order by beginTime desc
        limit #{pageNo},#{pageSize}
    </select>
    <select id="queryScooterMileage" resultType="java.math.BigDecimal">

    </select>

</mapper>